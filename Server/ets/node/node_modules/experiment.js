
/* Questa funzione legge i dati relativi ad un esperimento che sono di 
 * competenza di Drupal e li mette insieme ai dati che sono di competenza
 * di ehs/mhs. I dati vengono prima cercati in Redis e se non sono presenti
 * vengono chiesti a Drupal
 */

var Stash  = require('stash')
  , Step   = require('step')
  , Drupal = require('drupal')
 
var EXPERIMENTS = {}

// Stash is exported for tests
var stash = exports.stash = Stash.createClient();

// Used only for bogus experiments
exports.saveData = function (data) {
  var k = getKey(data.eId);
  stash.set(k, data);
}

exports.get = function (site, eId, cb) {
  
  var k = getKey(eId);

  Step (
    
    function() {
      stash.get(k, this);
    }
    
    ,
    
    function (err, data) {

      if (data) {
        this(null, data, true);
      } else {
        Drupal.createClient(site)
              .get('/ets/services/exp-info/' + eId, null, this);
      }

    }

    ,

    function (error, data, cached) {

      cached = cached || false;

      if (error) {
        cb && cb(error);
        return;
      }

      /* Se experiment rimane null, allora è la prima volta che viene
       * effettuata una richiesta dati per questo esperimento. I dati però
       * potrebbero essere stati chiesti da drupal (nel caso la cache fosse
       * scaduta) e in tal caso occorre aggiornare redis
       */
      var exp = retrieve(eId, false);
      
      if (exp) {
        // Esperimento già esistente, si aggiornano i dati
        exp.data = data;
      } else {
        // Esperimento non trovato: si crea e si salva in memoria
        exp = {};
        exp.eId = eId;
        exp.data = data;
        exp.instances = [];
        EXPERIMENTS[exp.eId] = exp;
      }

      exp.cached = cached;

      if (!cached) {
        stash.set(k, data, 120);
      }

      cb(null, exp);
    }

  );

}

var retrieve = exports.retrieve = function (eId, critical) {
  
  if ('undefined' == typeof EXPERIMENTS[eId]) {
    if (critical) {
      throw "The specified experiment is not in cache (but it should)";
    } else {
      return null;
    }
  } else {
    return EXPERIMENTS[eId]
  }
  
}

// for tests
exports.cacheExpire = function(eId, cb) {
  stash.del(getKey(eId), cb);
}

var getKey = function(eId) {
  return 'experiment:' + eId;
}
